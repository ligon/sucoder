#+title: sucoder

* Project Overview
Unix user and group permissions have been battle-tested for over fifty years.  When you bring on a new collaborator you give them their own account, set group read on shared files, and let the filesystem enforce the boundaries.  Why should an AI coding agent be any different?

=sucoder= treats an LLM agent (Codex, Claude, Gemini) as a collaborator with its own unix account.  The human's canonical repository is group-readable but not group-writable; the agent works in a sandboxed mirror clone where it has full write access.  No custom container runtimes, no bespoke sandboxing daemons---just =chown=, =chmod=, and =git=.

* Quick Start


#+begin_src shell
git clone https://github.com/ligon/sucoder && cd sucoder
make quick-start
cd ~/Projects/my-project  # any git repo
sucoder collaborate -a claude
#+end_src

No config file needed.  =sucoder= detects the git repo, mirrors it under =/var/tmp/coder-mirrors/=, and launches the agent.  Use =-a= to pick the agent (=claude=, =codex=, =gemini=); omit it and sucoder will auto-detect from PATH or prompt.  Add =--task fix-login= to start on a dedicated branch.

For multi-repo setups, skills, and system prompts, see [[*Configuration][Configuration]] below.  =make env-setup= does the full host provisioning (=make help= for all targets).

* Requirements
- Linux (user/group sandboxing relies on =useradd=, =groupadd=, and setgid)
- Python >= 3.9 with pip
- git
- sudo
- make (optional; you can run the setup commands by hand)
- bash
- At least one supported agent CLI on PATH: =claude=, =codex=, or =gemini=

* Why Org-mode?
This README is =.org=, the default system prompt is =.org=, and the skills repo leans heavily on Org-mode.  Why not Markdown?

Org-mode is a plain-text format that every LLM reads fluently—but it also has structured features (TODO states, properties, tags, executable source blocks) that Markdown lacks.  For a project about human-agent collaboration, those features pull their weight: a system prompt can carry metadata an agent can act on, a skill file can embed runnable examples, and a handoff note can be a living checklist rather than a static document.

You do not need Emacs to read or edit these files.  Any text editor works; GitHub renders =.org= natively.  But if you /do/ use Emacs, the integration is a bonus, not a requirement.

* What =sucoder collaborate= does

Running =sucoder collaborate -a claude= (or with =--task=) triggers a multi-step workflow.  Steps marked *auto* happen without intervention; steps marked *human* need you at the keyboard.

** 1. Resolve configuration /auto/
If =~/.sucoder/config.yaml= exists, load it.  Otherwise, derive everything from the environment: =$USER= becomes the human identity, the git repo root becomes the canonical repo, and =/var/tmp/coder-mirrors/= is the mirror root.  The agent CLI is resolved from =-a= flag > =$SUCODER_AGENT= > =~/.sucoder/agent= > PATH auto-detect > interactive prompt.

** 2. Prepare the canonical repository /auto/
Set group-read permissions on your repo so the =coder= user can traverse it.  Adds a =coder= git remote pointing at the mirror (for easy fetching later) and writes a helper script =scripts/fetch-agent-branches.sh=.  Your repo stays read-only to the agent—only the group bits and the remote config change.

** 3. Clone (or verify) the mirror /auto/
If the mirror does not exist under =/var/tmp/coder-mirrors/<repo>/=, clone it from the canonical repo as the =coder= user.  Push access back to canonical is disabled (=no_push=).  If the mirror already exists, verify the remote and enforce permissions.

** 4. Sync or create a task branch /auto/
- Without =--task=: fetch the latest commits from canonical into the mirror.
- With =--task fix-login=: create a branch =coder/fix-login-<timestamp>= in the mirror, based on the default base branch (or =--base=).

** 5. Compose the agent launch command /auto/
Detect the agent type (Claude, Codex, Gemini) from the command name and inject the appropriate flags: write-access (=--dangerously-skip-permissions=, =--sandbox danger-full-access=, =--yolo=), writable directories, skills paths, and system prompt.  If a system prompt file exists, it is passed via the agent's native flag or appended as trailing text.

** 6. Launch the agent /human/
The agent process starts inside the mirror working tree.  From here, *you are talking to the agent*.  It has full write access to the mirror but cannot write to your canonical repo.  The agent commits its work to the task branch.

When the agent session ends (you quit it, or it finishes), control returns to your shell.

** 7. Review and integrate /human/
Fetch the agent's branch into your canonical repo and review it:
#+begin_src shell
git fetch /var/tmp/coder-mirrors/my-project coder/fix-login-20250215180000
git checkout -b review/fix-login FETCH_HEAD
# ... review, test, iterate ...
git checkout main && git merge --ff-only review/fix-login
#+end_src
Or pull directly:
#+begin_src shell
git pull --ff-only /var/tmp/coder-mirrors/my-project coder/fix-login-20250215180000
#+end_src
The canonical repository remains unwritable by the agent throughout.

** Running the steps individually
=collaborate= bundles steps 2–6.  You can also run them separately:
| Command              | Step                                         |
|----------------------+----------------------------------------------|
| =prepare-canonical=  | Set permissions and add agent remote (step 2)|
| =agents-clone=       | Clone the mirror (step 3)                    |
| =sync=               | Fetch latest into the mirror (step 4)        |
| =start-task=         | Create a task branch (step 4)                |
| =agents-run=         | Launch the agent (steps 5–6)                 |

** Custom configuration (optional)
Skip this section if zero-config mode works for you.

1. Copy the sample configuration and adjust paths, users, and mirror names.
   #+begin_src shell
   install -d -m 750 ~/.sucoder
   cp config.example.yaml ~/.sucoder/config.yaml
   #+end_src
2. Update =~/.sucoder/config.yaml= so that:
   - =human_user= matches your login.
   - =agent_user= and =agent_group= match the agent account (default =coder=).
   - =mirror_root= points to the directory where agent mirrors will live.
   - =mirrors.<name>.canonical_repo= points at the human-owned repository.
3. Ensure the agent can read (but not write) the configuration directory and file.
   #+begin_src shell
   sudo chgrp coder ~/.sucoder
   sudo chmod 750 ~/.sucoder
   sudo chgrp coder ~/.sucoder/config.yaml
   sudo chmod 640 ~/.sucoder/config.yaml
   #+end_src
4. (Optional) Install the skills repository for agent capabilities.
   #+begin_src shell
   git clone https://github.com/ligon/sucoder-skills ~/Projects/sucoder-skills
   ln -s ~/Projects/sucoder-skills ~/.sucoder/skills
   sudo chgrp -R coder ~/Projects/sucoder-skills
   sudo chmod -R g+r,g-w ~/Projects/sucoder-skills
   #+end_src

* Key Features
- agents-clone :: Clone a canonical repository into an agent-owned mirror with strict permissions.
- sync :: Fetch updates from the canonical repository into the mirror without granting write access.
- start-task :: Create a new agent task branch based on a human branch while preserving branch naming conventions.
- status :: Summarize the state of a mirror, including permissions and git remotes.
- collaborate :: Prepare canonical, ensure mirror, and launch agent in one step.
- version :: Print the installed sucoder version.
- --dry-run :: Available on modifying commands to review logged operations without executing.

* Usage
#+begin_src shell
# Clone the canonical repository into the configured mirror.
sucoder agents-clone project

# Refresh the mirror with the latest human commits.
sucoder sync project

# Create a task branch for the agent starting from ligon/main.
sucoder start-task project rewrite-parser --base main

# Inspect current branch and outstanding changes.
sucoder status project
#+end_src

* Configuration
Configuration is stored in YAML (default path is ~/.sucoder/config.yaml for the human operator).  Grant the agent group read access to this file while keeping it group-writable disabled.

#+begin_src yaml
human_user: ligon
agent_user: coder
agent_group: coder
mirror_root: /var/tmp/coder-mirrors
log_dir: ~/.sucoder/logs
skills:
  - ~/.sucoder/skills  # optional global default for all mirrors (overridable per-mirror)
system_prompt: ~/.sucoder/system_prompt.org
mirrors:
  project:
    canonical_repo: ~/src/project.git
    mirror_name: project
    default_base_branch: main
    task_branch_prefix: task
    branch_prefixes:
      human: ligon
      agent: coder
    # Optional: override or extend global skills for this mirror
    skills:
      - ~/.sucoder/skills/org-style
      - ~/.sucoder/skills/document-skill
    agent_launcher:
      # Optional: map generic intents to agent-specific flags
      needs_yolo: true
      writable_dirs:
        - "~"
      flags:
        skills: "--skills {path}"  # Uses mirror skills or ~/.sucoder/skills by default
#+end_src
You can also maintain a global catalog at =~/.sucoder/skills/SKILLS.md=, which can
point to additional skill files or directories using =file:= links or bullet-listed paths. Any
catalog discovered this way is loaded automatically before launching the agent.

The =agent_launcher.flags= mapping lets you translate generic intents (write access, writable
directories, workdir, default flags, skills paths) into agent-specific switches. If a skills flag
template is provided, sucoder will pass any configured skills plus the default
=~/.sucoder/skills= directory when it exists.

** Agent flag templates by CLI
The table below documents the current default flag templates used when the agent type is detected.
Templates can be overridden per-mirror or globally via =agent_launcher.flags=, with precedence:
per-mirror > global > profile > UNKNOWN.

| Template        | Intent                      | Codex default                                         | Claude default               | Gemini default                     | Notes |
|----------------+-----------------------------+-------------------------------------------------------+------------------------------+------------------------------------+-------|
| yolo           | Unsafe/full access mode     | --sandbox danger-full-access --ask-for-approval never | --dangerously-skip-permissions | --yolo                           | Injected when needs_yolo is true (or defaulted). |
| writable_dir   | Allow extra writable paths  | (none)                                                | --add-dir {path}             | --include-directories {path}      | Codex uses sandbox policy instead of per-dir flags. |
| workdir        | Set agent working directory | (none)                                                | (none)                       | (none)                             | Only applied if you set a template. |
| default_flag   | Pass through default flags  | {flag}                                                | {flag}                       | {flag}                             | Each default flag is rendered through this template. |
| skills         | Expose skills paths         | (none)                                                | (none)                       | (none)                             | Use "--skills {path}" or similar if your CLI supports it. |
| system_prompt  | Inject system prompt        | (none)                                                | --system-prompt              | --prompt-interactive               | If unset, sucoder appends the prompt as trailing text when inline prompts are supported. |

If you change any defaults, update =AGENT_PROFILES= in =sucoder/config.py= alongside the
README so the documentation stays in sync.

** Pin Node Version with nvm
Some agents (notably Codex) bundle Node.js; =sucoder= can wrap the launch so that the
agent runs under a specific nvm-managed runtime (for example Node 22).

1. Install/activate the desired version for the agent user:
   #+begin_src shell
   sudo -u coder bash -lc 'export NVM_DIR=/home/coder/.nvm; . "$NVM_DIR/nvm.sh"; nvm install 22.11.0'
   sudo -u coder bash -lc 'export NVM_DIR=/home/coder/.nvm; . "$NVM_DIR/nvm.sh"; nvm alias default 22.11.0'
   #+end_src
   Replace the version string with the release you need (direct versions, =lts/*= aliases, etc.).

2. Update the mirror configuration so launches always source nvm before running the agent:
   #+begin_src yaml
   mirrors:
     project:
       canonical_repo: ~/src/project.git
       agent_launcher:
         command:
           - codex
         nvm:
           version: "22.11.0"   # Any version/alias `nvm use` understands
           dir: /home/coder/.nvm  # Optional; defaults to <agent home>/.nvm
   #+end_src

When the =nvm= block is present, the launcher injects:
- =export NVM_DIR=…; source "$NVM_DIR/nvm.sh"=
- =nvm use <version>= (fails fast if the version is missing)
- =exec <agent> …= so the rest of the CLI arguments (including the injected write-access
  flags and context prelude) are preserved.

If =dir= is omitted the helper assumes the agent’s home directory contains =~.nvm=.
Any existing =agent_launcher.command= and =agent_launcher.env= settings continue to work.

Workspace skills follow Anthropic’s Agent Skills Spec:
- Each skill directory must contain a =SKILL.md= file with YAML frontmatter (`name`, `description`,
  and `license`; add `allowed-tools`/`metadata` as needed). If you copy a third-party skill, keep its
  license value and include the upstream notice in the directory.

** Unified skills catalog (local + curated)
- Generate a tool-agnostic catalog of local skills (from the configured skills directory) plus the openai/skills curated list:
  #+begin_src shell
  python scripts/generate_unified_skills_catalog.py \
    --output ../Skills/UNIFIED_SKILLS_CATALOG.md   # choose any writable path
  #+end_src
  The script reads =../Skills/trusted_skill_sources.yaml= to determine which sources to include (local catalogs plus curated repos; defaults include =openai/skills= and =anthropics/skills=). If a target is not writable (for example =/home/ligon/.sucoder/skills=), use =--output= to pick a writable path.
- The generated catalog shows entries per source and flags conflicts when the same skill name appears in multiple sources.
- Any LLM can read the catalog and follow linked =SKILL.md= files. Curated entries are documentation-first; helper scripts are optional.
- To install a curated skill manually, download =skills/.curated/<name>= from https://github.com/openai/skills and place it under your skills directory (e.g., =~/.sucoder/skills=).
- The frontmatter `name` must match the directory name exactly.
- Long-form references, scripts, and assets live under =references/=, =scripts/=, and =assets/= to
  keep the entrypoint concise.
- The shared catalog (=~/.sucoder/skills/SKILLS.md=) in the skills repository lists every bundled skill so agents discover them automatically.
- A reusable system prompt template (`default_system_prompt.org`) mirrors these expectations, including a reminder to confirm today's date at session start.
- The upstream workflow is available in the =sucoder-skills= repository under =skill-creator/=; use it alongside =document-skill= when you need initialization or packaging scripts.
- A starter configuration (`default_config.yaml`) points at the bundled skills directory and default prompt; copy or merge it into =~/.sucoder/config.yaml= as needed.

Resource directories are summarized automatically when present:
- =references/= — documentation to load on demand.
- =scripts/= — helper executables (never run automatically; humans can execute after review).
- =assets/= — supporting files such as templates or images that may be referenced in outputs.

* Skills Repository

Skills are maintained in a separate repository (=sucoder-skills=) for security isolation.
This separation prevents agents from modifying skills and tool code in the same commit, reducing
the attack surface and simplifying security reviews.

** Why Skills Are Separate

1. *Security Isolation* — An agent working on tool code cannot simultaneously modify skills
   that influence agent behavior.
2. *Review Clarity* — Code reviews and content reviews use different security mindsets and
   can be performed separately.
3. *Blast Radius Reduction* — Malicious skill instructions cannot be hidden among tool code changes.

** Version Compatibility

The tool enforces semantic versioning compatibility between itself and the skills repository:

- Tool validates skills repository =VERSION= file on startup
- Compatible: Tool requires =1.0.0=, skills has =1.x.x= ✓
- Incompatible: Tool requires =1.x.x=, skills has =2.0.0= ✗

Skills repository: https://github.com/ligon/sucoder-skills

To update skills:
#+begin_src shell
cd ~/.sucoder/skills  # Or ~/Projects/sucoder-skills
git pull
#+end_src

To skip version checking (not recommended):
#+begin_src shell
export SUCODER_SKIP_SKILLS_VERSION=1
#+end_src

** Version Bumping Strategy

*PATCH (1.0.0 → 1.0.1)*: Typo fixes, clarifications, examples
*MINOR (1.0.0 → 1.1.0)*: New skills, new optional features, backward-compatible improvements
*MAJOR (1.0.0 → 2.0.0)*: Breaking changes, requires tool update

* Testing
Run the automated tests with pytest.

#+begin_src shell
pytest
#+end_src

* Next Steps
- Harden permission checks to verify that the canonical repository is mounted read-only for the agent user.

* Packaging
This project uses Poetry for packaging and dependency management.

#+begin_src shell
# Install dependencies (editable mode for development)
poetry install

# Run the CLI
poetry run sucoder --help

# Build source and wheel distributions
poetry build
#+end_src
