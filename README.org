#+title: sucoder

* Project Overview
The goal of this project is to enable a safe collaboration workflow between a human maintainer and an LLM agent.  The human owns the canonical repository, while the agent works inside a sandboxed mirror clone.  Access controls ensure the agent has read-only access to the canonical repository and read-write access to the mirror.

* Key Features
- agents-clone :: Clone a canonical repository into an agent-owned mirror with strict permissions.
- sync :: Fetch updates from the canonical repository into the mirror without granting write access.
- start-task :: Create a new agent task branch based on a human branch while preserving branch naming conventions.
- status :: Summarize the state of a mirror, including permissions and git remotes.
- collaborate :: Prepare canonical, ensure mirror, and launch agent in one step.
- version :: Print the installed sucoder version.
- --dry-run :: Available on modifying commands to review logged operations without executing.

* Usage
#+begin_src shell
# Clone the canonical repository into the configured mirror.
sucoder agents-clone project

# Refresh the mirror with the latest human commits.
sucoder sync project

# Create a task branch for the agent starting from ligon/main.
sucoder start-task project rewrite-parser --base main

# Inspect current branch and outstanding changes.
sucoder status project
#+end_src

* Quick Start / How To
For a holistic rebuild of the surrounding environment (accounts, perms, skills, prompts), see =docs/host-environment-setup.org=.
The top-level =Makefile= automates common host setup tasks; run =make= (defaults to =env-setup=) or =make help= for targets.

** Prepare Configuration
1. Copy the sample configuration and adjust paths, users, and mirror names.
   #+begin_src shell
   install -d -m 750 ~/.sucoder
   cp config.example.yaml ~/.sucoder/config.yaml
   #+end_src
2. Update `~/.sucoder/config.yaml` so that:
   - `human_user` matches your login (for example `ligon`).
   - `agent_user` and `agent_group` match the agent account (default `coder`).
   - `mirror_root` points to the directory where agent mirrors will live.
   - `mirrors.<name>.canonical_repo` points at the human-owned repository.
3. Ensure the agent can read (but not write) the configuration directory and file.
   #+begin_src shell
   sudo chgrp coder ~/.sucoder
   sudo chmod 750 ~/.sucoder
   sudo chgrp coder ~/.sucoder/config.yaml
   sudo chmod 640 ~/.sucoder/config.yaml
   #+end_src
4. (Optional) Create a global system prompt file that will be preloaded for every agent session.
   #+begin_src shell
   cat > ~/.sucoder/system_prompt.org <<'EOF'
   #+TITLE: Workspace System Prompt
   #+DESCRIPTION: Shared context that every agent should load.

   - Summarize high-level expectations for the workspace here.
   - Add links or commands you want the agent to run before starting tasks.
   EOF
   #+end_src
5. Install the skills repository (required for agent capabilities).
   #+begin_src shell
   # Clone the skills repository
   git clone https://github.com/ligon/sucoder-skills ~/Projects/sucoder-skills

   # Create symlink from config directory
   ln -s ~/Projects/sucoder-skills ~/.sucoder/skills

   # Ensure agent can read skills
   sudo chgrp -R coder ~/Projects/sucoder-skills
   sudo chmod -R g+r ~/Projects/sucoder-skills
   sudo chmod -R g-w ~/Projects/sucoder-skills
   #+end_src

   *Note*: The skills repository is separate from the tool repository for security isolation.
   Skills influence agent behavior and are kept in a dedicated repository to prevent agents
   from modifying skills and tool code in the same commit. The tool enforces semantic
   versioning compatibility between the tool and skills repository.
6. Warm up the shared skills catalog so launches confirm access before work starts.
   #+begin_src shell
   ls ~/.sucoder/skills
   sucoder skills-list
   sucoder mirrors-list
   cat ~/.sucoder/skills/SKILLS.md
   #+end_src
   The listings should succeed without permission errors. The CLI helper highlights any unreadable
   paths, and =sucoder mirrors-list= prints the configured mirrors (with their canonical and mirror directories).
   Reading the =SKILLS.md= catalog verifies the skills are accessible and shows what is available.

** Provision the Mirror
1. Prepare the canonical repository for collaboration.
   #+begin_src shell
   sucoder prepare-canonical project
   #+end_src
   This command sets the group to `coder`, grants group read permissions, and removes group write bits.  Elevate with `--sudo` when root privileges are required.
   By default it also adds a `coder` remote pointing at the agent mirror and writes
   =scripts/fetch-agent-branches.sh= to simplify fetching agent branches (`--no-agent-remote` disables this).
2. Clone the mirror as the human operator; the tool will invoke git as the agent.
   #+begin_src shell
   sucoder agents-clone project --verbose
   #+end_src
   Mirror arguments support shell completion, so pressing Tab after `sucoder <command> ` suggests configured mirror names.

** Sync Before Handing Off
1. Refresh the mirror with the latest human commits.
   #+begin_src shell
   sucoder sync project
   #+end_src
2. Create a task branch for the agent based on the desired human branch.
   #+begin_src shell
   sucoder start-task project add-metrics --base main
   #+end_src
   The command prints the full branch name (for example `coder/add-metrics-20251107164028`).

** Agent Workflow
- The agent works directly inside the mirror directory (for example `/var/tmp/coder-mirrors/project`) on the branch created above.
- The agent commits work to `coder/<task>-<timestamp>` without pushing to the canonical repository.
- To run the full workflow in one step (prepare canonical, ensure mirror, launch agent), use:
  #+begin_src shell
  sucoder collaborate project --task add-metrics
  #+end_src
#  Adjust flags such as `--no-agent-remote`, `--sudo`, or extra arguments just as you would with the individual commands.

- To experiment with a different agent binary temporarily, supply `--agent-command` (and optional `--agent-env`):
  #+begin_src shell
  sucoder agents-run project --agent-command "foo --flag" --agent-env TOKEN=abc123
  #+end_src

- The CLI detects the agent type (Codex, Claude, Gemini) and automatically injects the appropriate write-access flags (for example =--sandbox danger-full-access= for Codex, =--dangerously-skip-permissions= for Claude, =--yolo= for Gemini) so the agent can write to the mirror.  The helper will also warn if it detects a read-only sandbox and still attempts a launch.

- Org authoring playground (documentation example): =docs/examples/org-authoring-demo.org=.
  Demonstrates the in-repo Org skills—structure, markup, tables, capture, citations,
  exporting, agenda integration—so humans and agents have a quick reference.

** Human: Review and Integrate Agent Work
1. Fetch the agent branch back into the canonical repository.
   #+begin_src shell
   git -C <canonical-repo> fetch <mirror-path> coder/add-metrics-20251107164028
   #+end_src
2. Check out and review the branch inside the canonical repository.
   #+begin_src shell
   git -C <canonical-repo> checkout -b review/add-metrics FETCH_HEAD
   #+end_src
3. Fast-forward the reviewed branch to keep history linear (default):
   #+begin_src shell
   git -C <canonical-repo> checkout main
   git -C <canonical-repo> merge --ff-only review/add-metrics
   #+end_src
   If the branch is not fast-forwardable because main advanced, choose either a single merge commit or rebase the review branch onto main, then retry `merge --ff-only`. If you prefer to pull directly from the agent mirror, you can do so without setting global pull defaults:
   #+begin_src shell
   git -C <canonical-repo> pull --ff-only <mirror-path> coder/add-metrics-20251107164028
   #+end_src
   The canonical repository remains unwritable by the agent throughout this flow.

* Configuration
Configuration is stored in YAML (default path is ~/.sucoder/config.yaml for the human operator).  Grant the agent group read access to this file while keeping it group-writable disabled.

#+begin_src yaml
human_user: ligon
agent_user: coder
agent_group: coder
mirror_root: /var/tmp/coder-mirrors
log_dir: ~/.sucoder/logs
skills:
  - ~/.sucoder/skills  # optional global default for all mirrors (overridable per-mirror)
system_prompt: ~/.sucoder/system_prompt.org
mirrors:
  project:
    canonical_repo: ~/src/project.git
    mirror_name: project
    default_base_branch: main
    task_branch_prefix: task
    branch_prefixes:
      human: ligon
      agent: coder
    # Optional: override or extend global skills for this mirror
    skills:
      - ~/.sucoder/skills/org-style
      - ~/.sucoder/skills/document-skill
    agent_launcher:
      # Optional: map generic intents to agent-specific flags
      needs_yolo: true
      writable_dirs:
        - "~"
      flags:
        skills: "--skills {path}"  # Uses mirror skills or ~/.sucoder/skills by default
#+end_src
You can also maintain a global catalog at =~/.sucoder/skills/SKILLS.md=, which can
point to additional skill files or directories using =file:= links or bullet-listed paths. Any
catalog discovered this way is loaded automatically before launching the agent.

The =agent_launcher.flags= mapping lets you translate generic intents (write access, writable
directories, workdir, default flags, skills paths) into agent-specific switches. If a skills flag
template is provided, sucoder will pass any configured skills plus the default
=~/.sucoder/skills= directory when it exists.

** Agent flag templates by CLI
The table below documents the current default flag templates used when the agent type is detected.
Templates can be overridden per-mirror or globally via =agent_launcher.flags=, with precedence:
per-mirror > global > profile > UNKNOWN.

| Template        | Intent                      | Codex default                                         | Claude default               | Gemini default                     | Notes |
|----------------+-----------------------------+-------------------------------------------------------+------------------------------+------------------------------------+-------|
| yolo           | Unsafe/full access mode     | --sandbox danger-full-access --ask-for-approval never | --dangerously-skip-permissions | --yolo                           | Injected when needs_yolo is true (or defaulted). |
| writable_dir   | Allow extra writable paths  | (none)                                                | --add-dir {path}             | --include-directories {path}      | Codex uses sandbox policy instead of per-dir flags. |
| workdir        | Set agent working directory | (none)                                                | (none)                       | (none)                             | Only applied if you set a template. |
| default_flag   | Pass through default flags  | {flag}                                                | {flag}                       | {flag}                             | Each default flag is rendered through this template. |
| skills         | Expose skills paths         | (none)                                                | (none)                       | (none)                             | Use "--skills {path}" or similar if your CLI supports it. |
| system_prompt  | Inject system prompt        | (none)                                                | --system-prompt              | --prompt-interactive               | If unset, sucoder appends the prompt as trailing text when inline prompts are supported. |

If you change any defaults, update =AGENT_PROFILES= in =sucoder/config.py= alongside the
README so the documentation stays in sync.

** Pin Node Version with nvm
Some agents (notably Codex) bundle Node.js; =sucoder= can wrap the launch so that the
agent runs under a specific nvm-managed runtime (for example Node 22).

1. Install/activate the desired version for the agent user:
   #+begin_src shell
   sudo -u coder bash -lc 'export NVM_DIR=/home/coder/.nvm; . "$NVM_DIR/nvm.sh"; nvm install 22.11.0'
   sudo -u coder bash -lc 'export NVM_DIR=/home/coder/.nvm; . "$NVM_DIR/nvm.sh"; nvm alias default 22.11.0'
   #+end_src
   Replace the version string with the release you need (direct versions, =lts/*= aliases, etc.).

2. Update the mirror configuration so launches always source nvm before running the agent:
   #+begin_src yaml
   mirrors:
     project:
       canonical_repo: ~/src/project.git
       agent_launcher:
         command:
           - codex
         nvm:
           version: "22.11.0"   # Any version/alias `nvm use` understands
           dir: /home/coder/.nvm  # Optional; defaults to <agent home>/.nvm
   #+end_src

When the =nvm= block is present, the launcher injects:
- =export NVM_DIR=…; source "$NVM_DIR/nvm.sh"=
- =nvm use <version>= (fails fast if the version is missing)
- =exec <agent> …= so the rest of the CLI arguments (including the injected write-access
  flags and context prelude) are preserved.

If =dir= is omitted the helper assumes the agent’s home directory contains =~.nvm=.
Any existing =agent_launcher.command= and =agent_launcher.env= settings continue to work.

Workspace skills follow Anthropic’s Agent Skills Spec:
- Each skill directory must contain a =SKILL.md= file with YAML frontmatter (`name`, `description`,
  and `license`; add `allowed-tools`/`metadata` as needed). If you copy a third-party skill, keep its
  license value and include the upstream notice in the directory.

** Unified skills catalog (local + curated)
- Generate a tool-agnostic catalog of local skills (from the configured skills directory) plus the openai/skills curated list:
  #+begin_src shell
  python scripts/generate_unified_skills_catalog.py \
    --output ../Skills/UNIFIED_SKILLS_CATALOG.md   # choose any writable path
  #+end_src
  The script reads =../Skills/trusted_skill_sources.yaml= to determine which sources to include (local catalogs plus curated repos; defaults include =openai/skills= and =anthropics/skills=). If a target is not writable (for example =/home/ligon/.sucoder/skills=), use =--output= to pick a writable path.
- The generated catalog shows entries per source and flags conflicts when the same skill name appears in multiple sources.
- Any LLM can read the catalog and follow linked =SKILL.md= files. Curated entries are documentation-first; helper scripts are optional.
- To install a curated skill manually, download =skills/.curated/<name>= from https://github.com/openai/skills and place it under your skills directory (e.g., =~/.sucoder/skills=).
- The frontmatter `name` must match the directory name exactly.
- Long-form references, scripts, and assets live under =references/=, =scripts/=, and =assets/= to
  keep the entrypoint concise.
- The shared catalog (=~/.sucoder/skills/SKILLS.md=) in the skills repository lists every bundled skill so agents discover them automatically.
- A reusable system prompt template (`default_system_prompt.org`) mirrors these expectations, including a reminder to confirm today's date at session start.
- The upstream workflow is available in the =sucoder-skills= repository under =skill-creator/=; use it alongside =document-skill= when you need initialization or packaging scripts.
- A starter configuration (`default_config.yaml`) points at the bundled skills directory and default prompt; copy or merge it into =~/.sucoder/config.yaml= as needed.

Resource directories are summarized automatically when present:
- =references/= — documentation to load on demand.
- =scripts/= — helper executables (never run automatically; humans can execute after review).
- =assets/= — supporting files such as templates or images that may be referenced in outputs.

* Skills Repository

Skills are maintained in a separate repository (=sucoder-skills=) for security isolation.
This separation prevents agents from modifying skills and tool code in the same commit, reducing
the attack surface and simplifying security reviews.

** Why Skills Are Separate

1. *Security Isolation* — An agent working on tool code cannot simultaneously modify skills
   that influence agent behavior.
2. *Review Clarity* — Code reviews and content reviews use different security mindsets and
   can be performed separately.
3. *Blast Radius Reduction* — Malicious skill instructions cannot be hidden among tool code changes.

** Version Compatibility

The tool enforces semantic versioning compatibility between itself and the skills repository:

- Tool validates skills repository =VERSION= file on startup
- Compatible: Tool requires =1.0.0=, skills has =1.x.x= ✓
- Incompatible: Tool requires =1.x.x=, skills has =2.0.0= ✗

Skills repository: https://github.com/ligon/sucoder-skills

To update skills:
#+begin_src shell
cd ~/.sucoder/skills  # Or ~/Projects/sucoder-skills
git pull
#+end_src

To skip version checking (not recommended):
#+begin_src shell
export SUCODER_SKIP_SKILLS_VERSION=1
#+end_src

** Version Bumping Strategy

*PATCH (1.0.0 → 1.0.1)*: Typo fixes, clarifications, examples
*MINOR (1.0.0 → 1.1.0)*: New skills, new optional features, backward-compatible improvements
*MAJOR (1.0.0 → 2.0.0)*: Breaking changes, requires tool update

* Testing
Run the automated tests with pytest.

#+begin_src shell
pytest
#+end_src

* Next Steps
- Harden permission checks to verify that the canonical repository is mounted read-only for the agent user.

* Packaging
This project uses Poetry for packaging and dependency management.

#+begin_src shell
# Install dependencies (editable mode for development)
poetry install

# Run the CLI
poetry run sucoder --help

# Build source and wheel distributions
poetry build
#+end_src
